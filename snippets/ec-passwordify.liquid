{% comment %} Version: 1.0 {% endcomment %}

{% comment %} 
------------------------------------------------------------------------
This file is automatically managed by Emerson Code's Passwordify. 
Please do not edit this file. 
Email support@emersoncode.com with any questions. 
------------------------------------------------------------------------
{% endcomment %}

{% include 'ec-passwordify-data' %}

{% assign shieldEnabled = false %}
{% assign shieldUnlocked = false %}

{% assign savedShieldCreds = cart.attributes['savedShieldCreds'] | split: ',' %}

{% if article.id %}
  {% assign shieldCurrentID = article.id %}
  {% assign pageType = "article" %}
{% elsif collection.id %}
  {% assign shieldCurrentID = collection.id %}
  {% assign pageType = "collection" %}
{% elsif product.id %}
  {% assign shieldCurrentID = product.id %}
  {% assign pageType = "product" %}
{% elsif page.id %}
  {% assign shieldCurrentID = page.id %}
  {% assign pageType = "page" %}
{% else %}
  {% assign shieldCurrentID = 0 %}
  {% assign pageType = "unknown" %}
{% endif %}

{% assign shieldCurrentIDStr = shieldCurrentID | downcase %}
{% assign shieldEnabledIDs = shield_pp_ids | split: ',' %}
{% assign shieldEnabledPasswords = shield_pp_keys | split: ',' %}
{% assign shieldEnabledTags = shield_pp_tags | split: '&,&' %}
{% assign shieldEnabledMessages = shield_pp_messages | split: "&,&" %}

{% assign indexCount = 0 %}
{% assign foundIndex = 0 %}

{% for ID in shieldEnabledIDs %}
{% if pageType == "product" %}
  {% for collection in product.collections %}
    {% if ID == collection.id %}
      {% assign foundIndex = indexCount %}
      {% assign shieldEnabled = true %}
    {% endif %}
  {% endfor %}
{% endif %}
{% if ID == shieldCurrentIDStr %}
  {% assign foundIndex = indexCount %}
  {% assign shieldEnabled = true %}
{% endif %}
{% assign indexCount = indexCount | plus: 1 %}
{% endfor %}
 

{% if shieldEnabled %}
  {% assign thisPassword = shieldEnabledPasswords[foundIndex] %}
  {% assign thisTags = shieldEnabledTags[foundIndex] %}
  {% assign thisMessage = shieldEnabledMessages[foundIndex] %}

  {% if thisPassword != blank %}
    {% assign shieldType = "password" %}
  {% else if thisTags != blank %}
    {% assign shieldType = "tags" %}
  {% else %}
    {% assign shieldType = "unknown" %}
  {% endif %}

  {% for password in savedShieldCreds %}
    {% if password == thisPassword %}
      {% assign shieldUnlocked = true %}
    {% endif %}
  {% endfor  %}

  {% for tags in shieldEnabledTags %}
    {% assign allowedTagsArray = tags | split: ',' %}
    {% for allowedTag in allowedTagsArray %}
      {% if customer.tags contains allowedTag %}
        {% assign shieldUnlocked = true %}
      {% endif %}
    {% endfor %}
  {% endfor  %}

  {% if true %}
    {% assign thisMessage = thisMessage | replace: "&apos;", "'" %}
    {% assign thisMessage = thisMessage | replace: "&quot;", '"' %}
    {% assign thisMessage = thisMessage | replace: "&lt;", "<" %}
    {% assign thisMessage = thisMessage | replace: "&gt;", ">" %}
    {% assign thisMessage = thisMessage | replace: "&amp;", "&" %}
    {% assign thisMessage = thisMessage | replace: "&#xHH;", "#" %}
  {% endif %}

{% endif %}

{% if shieldEnabled == false %}
  {{ ec-pw-ify }}
{% elsif shieldEnabled == true and shieldUnlocked == true %}
  {{ ec-pw-ify }}
{% else %}
<div id="passwordform">
  <div id="inner-div">
<div class="ec-passwordify-message" style="margin-bottom:15px">{{ thisMessage }}</div>
{% if shieldType == "password" %}
<form id="ec-passwordify-form">
  <input id="ec-protected_id" value="{{ shieldCurrentID }}" type="hidden" />
  <input id="ec-password" style="display: inline-block; width: 300px; max-width: 100%;" type="password" placeholder="Password" required autofocus>
  <span class="ec-passwordify-errors"></span>    
  <div style="margin-top:15px">
    <input id="ec-password-submit" class="btn" type="submit" value="Submit">
  </div>
  <span class="ec-error-message ec-pw-inc" style="display: none;">
    Password is incorrect.
  </span>
    </form></div>
</div>
{% else if shieldType == "tags" %}
{% if shop.customer_accounts_enabled %}
  {% if customer %}
    <span class="ec-error-message ec-acc-inc">
        Your account has not been granted access to this page yet.
    </span>
  {% else %}
    <h4>Login</h4>
    {% form 'customer_login' %}

      {{ form.errors | default_errors }}
      <div class="ec-login">
        <input style="display: inline-block; width: 300px; max-width: 100%;" type="email" placeholder="Email Address" name="customer[email]" />
      </div>
      <div class="ec-login">
        <input style="display: inline-block; width: 300px; max-width: 100%;" type="password" placeholder="Password" name="customer[password]" />
      </div>
      <div>
        <input style="display: inline-block; width: 300px; max-width: 100%;" type="submit" value="Sign In" />
      </div>

    {% endform %}
  {% endif %}
  {% else %}
  <span class="ec-error-message ec-no-acc">
    This page is locked by Passwordify, however the site administrator needs to <a target="_blank" rel="noopener" href="https://help.shopify.com/en/manual/customers/customer-accounts#set-your-customer-account-preferences">enable customer accounts</a> before entry can be permitted. 
  </span>
  {% endif %}
{% endif %}
<style type="text/css">
  .ec-error-message {
    color: #e74c3c;
  }
  .ec-login {
    margin-bottom: 18px;
  }
</style>
<script>
  function ecLoadScript(url, callback){
      var script = document.createElement("script")
      script.type = "text/javascript";
      if (script.readyState){  //IE
          script.onreadystatechange = function(){
              if (script.readyState == "loaded" ||
                      script.readyState == "complete"){
                  script.onreadystatechange = null;
                  callback();
              }
          };
      } else {  //Others
          script.onload = function(){
              callback();
          };
      }
      script.src = url;
      document.getElementsByTagName("head")[0].appendChild(script);
  }
     
  var ecPasswordShieldJS = function($){

    function ecUpdateCart(savedString) {
      var updateCartParams = {
        type: 'POST',
        url: '/cart/update.js',
        dataType: 'json',
        data: 'attributes[savedShieldCreds]=' + savedString,
        success: function(cart) {
          location.reload();
        },
        error: function(XMLHttpRequest, textStatus) {
          console.log('Error:' + textStatus);
        }
      };
      jQuery.ajax(updateCartParams);
    };


    function ecCheckCredentials(){

      var protected_id_val = jQuery('#ec-protected_id').val();
      var password_val = jQuery('#ec-password').val();

      var checkParams = {
        type: 'POST',
        url: '/apps/passwordify/verify',
        dataType: 'json',
        data: {
          protected_id: protected_id_val,
          password: password_val
        },
        success: function(response) {
         if(response.success == true){
            ecUpdateCart(String(password_val));
            
         } else {
            jQuery('.ec-error-message').show();
         }
        },
        error: function(XMLHttpRequest, textStatus) {
          console.log('Error:' + textStatus);
        }
      };
      jQuery.ajax(checkParams);
    }
    
    jQuery( "#ec-passwordify-form" ).submit(function( event ) {
      event.preventDefault();
      ecCheckCredentials();
    });
  };

  if ((typeof jQuery === 'undefined') || (parseFloat(jQuery.fn.jquery) < 1.7)) {
    ecLoadScript('//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js', function(){
      jQuery191 = jQuery.noConflict(true);
      ecPasswordShieldJS(jQuery191);
    });
  } else {
    jQuery( document ).ready(function() {
      ecPasswordShieldJS(jQuery);
    });
  }
</script>
{% endif %}